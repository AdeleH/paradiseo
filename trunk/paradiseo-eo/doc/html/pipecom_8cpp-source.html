<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>EO: pipecom.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000011.html">utils</a></div>
<h1>pipecom.cpp</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/* ----------------------------------------------------------------------</span>
00002 <span class="comment"> * Where........: CMAP - Polytechnique</span>
00003 <span class="comment"> * File.........: pipecom.c</span>
00004 <span class="comment"> * Author.......: Bertrand Lamy (Equipe genetique)</span>
00005 <span class="comment"> * Created......: Mon Mar 13 13:50:11 1995</span>
00006 <span class="comment"> * Description..: Communication par pipe bidirectionnel avec un autre process</span>
00007 <span class="comment"> * ----------------------------------------------------------------------</span>
00008 <span class="comment"> */</span>
00009 
00010 <span class="comment">// MSC equivalent must be written and tested or some #idef instructions added</span>
00011 <span class="comment">// with a clear message at compile time that this is for Unix only ???</span>
00012 
00013 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00018 <span class="preprocessor">#include &lt;cstring&gt;</span>
00019 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00020 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00021 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00022 
00023 <span class="preprocessor">#include "pipecom.h"</span>
00024 
00025 
00026 
00027 <span class="keywordtype">int</span> Check( PCom *com )
00028 {
00029     <span class="keywordflow">if</span>( ! com ) {
00030         fprintf( stderr, <span class="stringliteral">"PipeCom: Null pointer.\n"</span> );
00031         fflush( stderr );
00032         <span class="keywordflow">return</span> 0;
00033     }
00034     <span class="keywordflow">if</span>( kill( com-&gt;pid, 0 ) != 0 ) {
00035         fprintf( stderr, <span class="stringliteral">"PipeCom: process doesn't exists.\n"</span> );
00036         fflush( stderr );
00037         <span class="keywordflow">return</span> 0;
00038     }
00039     <span class="keywordflow">return</span> 1;
00040 }
00041 
00042 
00043 PCom * PipeComOpen( <span class="keywordtype">char</span> *prog )
00044 {
00045     <span class="keywordtype">char</span>        *args[2];
00046     args[0] = prog;
00047     args[1] = NULL;
00048     <span class="keywordflow">return</span> PipeComOpenArgv( prog, args );
00049 }
00050 
00051 
00052 PCom * PipeComOpenArgv( <span class="keywordtype">char</span> *prog, <span class="keywordtype">char</span> *argv[] )
00053 {
00054     <span class="keywordtype">int</span>         toFils[2];
00055     <span class="keywordtype">int</span>         toPere[2];
00056     <span class="keywordtype">int</span>         sonPid;
00057     PCom        * ret = NULL;
00058 
00059     <span class="keywordflow">if</span>( pipe( toFils ) &lt; 0 ) {
00060         perror( <span class="stringliteral">"PipeComOpen: Creating pipes"</span> );
00061         <span class="keywordflow">return</span> ret;
00062     }
00063     <span class="keywordflow">if</span>( pipe( toPere ) &lt; 0 ) {
00064         perror( <span class="stringliteral">"PipeComOpen: Creating pipes"</span> );
00065         <span class="keywordflow">return</span> ret;
00066     }
00067 
00068     <span class="keywordflow">switch</span>( (sonPid = vfork()) ) {
00069     <span class="keywordflow">case</span> -1:
00070         perror(<span class="stringliteral">"PipeComOpen: fork failed"</span> );
00071         <span class="keywordflow">return</span> ret;
00072         <span class="keywordflow">break</span>;
00073 
00074     <span class="keywordflow">case</span> 0:
00075         <span class="comment">/* --- Here's the son --- */</span>
00076         <span class="comment">/* --- replace old stdin --- */</span>
00077         <span class="keywordflow">if</span>( dup2( toFils[0], fileno(stdin) ) &lt; 0 ) {
00078             perror( <span class="stringliteral">"PipeComOpen(son): could not connect"</span> );
00079             exit( -1 );
00080             <span class="comment">/* --- AVOIR: kill my father --- */</span>
00081         }
00082         <span class="keywordflow">if</span>( dup2( toPere[1], fileno(stdout) ) &lt; 0 ) {
00083             perror( <span class="stringliteral">"PipeComOpen(son): could not connect"</span> );
00084             exit( -1 );
00085         }
00086         <span class="keywordflow">if</span>( execvp( prog, argv ) &lt; 0 ) {
00087             perror( prog );
00088             perror( <span class="stringliteral">"PipeComOpen: can't exec"</span> );
00089             exit(1);
00090         }
00091         <span class="keywordflow">break</span>;
00092     <span class="keywordflow">default</span>:
00093         ret = (PCom *) malloc( <span class="keyword">sizeof</span>(PCom) );
00094         <span class="keywordflow">if</span>( ! ret )
00095             <span class="keywordflow">return</span> NULL;
00096 
00097         ret-&gt;fWrit = (FILE *)fdopen( toFils[1], <span class="stringliteral">"w"</span> );
00098         ret-&gt;fRead = (FILE *)fdopen( toPere[0], <span class="stringliteral">"r"</span> );
00099         ret-&gt;pid = sonPid;
00100     }
00101     <span class="keywordflow">return</span> ret;
00102 }
00103 
00104 
00105 <span class="keywordtype">int</span> PipeComSend( PCom *to, <span class="keyword">const</span> <span class="keywordtype">char</span> *line )
00106 {
00107     <span class="keywordtype">int</span> nb = 0;
00108     <span class="keywordflow">if</span>( ! Check(to ) )
00109         <span class="keywordflow">return</span> nb;
00110     nb = fprintf( to-&gt;fWrit, line );
00111     fflush( to-&gt;fWrit );
00112     <span class="keywordflow">return</span> nb;
00113 }
00114 
00115 
00116 <span class="keywordtype">int</span> PipeComSendn( PCom *to, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> n )
00117 {
00118     <span class="keywordtype">int</span> nb = 0;
00119     <span class="keywordflow">if</span>( ! Check(to) )
00120         <span class="keywordflow">return</span> nb;
00121 
00122     nb = fwrite( data, 1, n, to-&gt;fWrit );
00123     fflush( to-&gt;fWrit );
00124     <span class="keywordflow">return</span> nb;
00125 }
00126 
00127 
00128 <span class="keywordtype">int</span> PipeComReceive( PCom *from, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> max )
00129 {
00130     <span class="keywordflow">if</span>( ! Check(from) )
00131         <span class="keywordflow">return</span> 0;
00132     <span class="keywordflow">if</span>( ! data ) {
00133       fprintf( stderr, <span class="stringliteral">"PipeComReceive: Invalid data pointer\n"</span> );
00134       fflush( stderr );
00135       <span class="keywordflow">return</span> 0;
00136     }
00137     <span class="keywordflow">if</span>( fgets( data, max, from-&gt;fRead ) )
00138         <span class="keywordflow">return</span> strlen(data);
00139     <span class="keywordflow">return</span> 0;
00140 }
00141 
00142 
00143 
00144 <span class="keywordtype">int</span> PipeComClose( PCom *to )
00145 {
00146     <span class="keywordflow">if</span>( ! Check(to) )
00147         <span class="keywordflow">return</span> 0;
00148     fclose( to-&gt;fRead );
00149     fclose( to-&gt;fWrit );
00150     free( to );
00151     <span class="keywordflow">return</span> 1;
00152 }
00153 
00154 
00155 
00156 <span class="keywordtype">int</span> PipeComWaitFor( PCom *from, <span class="keywordtype">char</span> *what )
00157 {
00158     <span class="keywordtype">char</span>        buffer[256];
00159     <span class="keywordflow">do</span> {
00160         <span class="keywordflow">if</span>( ! PipeComReceive( from, buffer, 256 ) )
00161             <span class="keywordflow">return</span> 0;
00162     } <span class="keywordflow">while</span>( strcmp( buffer, what ) );
00163     <span class="keywordflow">return</span> 1;
00164 }
00165 
00166 
00167 
00168 <span class="comment">// Local Variables:</span>
00169 <span class="comment">// coding: iso-8859-1</span>
00170 <span class="comment">// c-file-style: "Stroustrup"</span>
00171 <span class="comment">// fill-column: 80</span>
00172 <span class="comment">// End:</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 19 05:06:41 2006 for EO by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
